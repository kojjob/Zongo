<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">My Products</h1>
      <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Manage your product listings</p>
    </div>
    <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-3">
      <%= link_to new_my_product_path, class: "inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" do %>
        <%= icon "plus", class: "w-5 h-5 mr-2" %>
        Add New Product
      <% end %>
      <%= link_to bulk_new_my_products_path, class: "inline-flex items-center justify-center px-5 py-2.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" do %>
        <%= icon "upload", class: "w-5 h-5 mr-2" %>
        Bulk Upload
      <% end %>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-8">
    <div class="flex flex-col md:flex-row md:items-end space-y-4 md:space-y-0 md:space-x-4">
      <%= form_with url: my_products_path, method: :get, class: "w-full", data: { turbo_frame: "products_list", turbo_action: "advance" } do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <%= f.label :search, "Search", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <div class="relative rounded-md shadow-sm">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <%= icon "search", class: "h-5 w-5 text-gray-400" %>
              </div>
              <%= f.text_field :search, value: params[:search], placeholder: "Search products...", class: "block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white sm:text-sm" %>
            </div>
          </div>

          <div>
            <%= f.label :category_id, "Category", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= f.select :category_id, 
                options_from_collection_for_select(@categories, :id, :name, params[:category_id]), 
                { include_blank: "All Categories" }, 
                class: "block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white sm:text-sm rounded-md" %>
          </div>

          <div>
            <%= f.label :status, "Status", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= f.select :status, 
                options_for_select([
                  ["All Statuses", ""],
                  ["Active", "active"],
                  ["Inactive", "inactive"],
                  ["Out of Stock", "out_of_stock"],
                  ["Discontinued", "discontinued"]
                ], params[:status]), 
                {}, 
                class: "block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white sm:text-sm rounded-md" %>
          </div>

          <div>
            <%= f.label :sort, "Sort By", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= f.select :sort, 
                options_for_select([
                  ["Newest", "newest"],
                  ["Oldest", "oldest"],
                  ["Name (A-Z)", "name_asc"],
                  ["Name (Z-A)", "name_desc"],
                  ["Price (Low to High)", "price_asc"],
                  ["Price (High to Low)", "price_desc"]
                ], params[:sort] || "newest"), 
                {}, 
                class: "block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white sm:text-sm rounded-md" %>
          </div>
        </div>

        <div class="mt-4 flex justify-end">
          <%= link_to "Clear Filters", my_products_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mr-3" %>
          <%= f.submit "Apply Filters", class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Bulk Actions -->
  <%= form_with url: bulk_edit_my_products_path, method: :get, id: "bulk_action_form" do |f| %>
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden mb-8">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-lg font-medium text-gray-900 dark:text-white">Product Listings (<%= @products.total_count %>)</h2>
        <div>
          <%= f.submit "Bulk Edit Selected", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed", disabled: true, data: { bulk_edit_button: true } %>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                <div class="flex items-center">
                  <input type="checkbox" id="select_all" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded dark:bg-gray-800" data-select-all>
                  <label for="select_all" class="ml-2 sr-only">Select All</label>
                </div>
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Product</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Category</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Price</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Stock</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Created</th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <% if @products.empty? %>
              <tr>
                <td colspan="8" class="px-6 py-12 text-center">
                  <div class="flex flex-col items-center">
                    <%= icon "shopping-bag", class: "h-12 w-12 text-gray-400 dark:text-gray-500 mb-4" %>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-1">No products found</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-4">Get started by creating your first product listing.</p>
                    <%= link_to new_my_product_path, class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" do %>
                      <%= icon "plus", class: "h-5 w-5 mr-2" %>
                      Add New Product
                    <% end %>
                  </div>
                </td>
              </tr>
            <% else %>
              <% @products.each do |product| %>
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <%= check_box_tag "product_ids[]", product.id, false, class: "h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded dark:bg-gray-800", data: { product_checkbox: true } %>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="h-10 w-10 flex-shrink-0">
                        <% if product.images.attached? %>
                          <%= image_tag product.images.first.variant(resize_to_fill: [40, 40]), class: "h-10 w-10 rounded-md object-cover" %>
                        <% else %>
                          <div class="h-10 w-10 rounded-md bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                            <%= icon "image", class: "h-6 w-6 text-gray-400 dark:text-gray-500" %>
                          </div>
                        <% end %>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">
                          <%= link_to product.name, my_product_path(product), class: "hover:text-primary-600 dark:hover:text-primary-400" %>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                          SKU: <%= product.sku %>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900 dark:text-white"><%= product.shop_category.name %></div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900 dark:text-white"><%= product.formatted_price %></div>
                    <% if product.on_sale? %>
                      <div class="text-xs text-gray-500 dark:text-gray-400 line-through">GHS <%= product.original_price %></div>
                      <div class="text-xs text-green-600 dark:text-green-400">-<%= product.discount_percentage %>%</div>
                    <% end %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <% if product.low_stock? %>
                      <div class="text-sm text-amber-600 dark:text-amber-400 font-medium"><%= product.stock_quantity %> <span class="text-xs">(Low)</span></div>
                    <% elsif product.stock_quantity == 0 %>
                      <div class="text-sm text-red-600 dark:text-red-400 font-medium">Out of stock</div>
                    <% else %>
                      <div class="text-sm text-gray-900 dark:text-white"><%= product.stock_quantity %></div>
                    <% end %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <% case product.status %>
                    <% when "active" %>
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">
                        Active
                      </span>
                    <% when "inactive" %>
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">
                        Inactive
                      </span>
                    <% when "out_of_stock" %>
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">
                        Out of Stock
                      </span>
                    <% when "discontinued" %>
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">
                        Discontinued
                      </span>
                    <% end %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    <%= product.created_at.strftime("%b %d, %Y") %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <div class="flex justify-end space-x-2">
                      <%= link_to edit_my_product_path(product), class: "text-primary-600 dark:text-primary-400 hover:text-primary-900 dark:hover:text-primary-300" do %>
                        <%= icon "edit", class: "h-5 w-5" %>
                      <% end %>
                      <%= button_to my_product_path(product), method: :delete, form: { data: { turbo_confirm: "Are you sure you want to delete this product?" } }, class: "text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300" do %>
                        <%= icon "trash", class: "h-5 w-5" %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>

      <% if @products.total_pages > 1 %>
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
          <%== pagy_nav(@pagy) %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    const selectAllCheckbox = document.querySelector('[data-select-all]');
    const productCheckboxes = document.querySelectorAll('[data-product-checkbox]');
    const bulkEditButton = document.querySelector('[data-bulk-edit-button]');
    
    if (selectAllCheckbox && productCheckboxes.length > 0 && bulkEditButton) {
      // Select all functionality
      selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        productCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        updateBulkEditButton();
      });
      
      // Individual checkbox change
      productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateBulkEditButton();
          
          // Update select all checkbox
          const allChecked = Array.from(productCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(productCheckboxes).some(cb => cb.checked);
          
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
      });
      
      // Update bulk edit button state
      function updateBulkEditButton() {
        const anyChecked = Array.from(productCheckboxes).some(cb => cb.checked);
        bulkEditButton.disabled = !anyChecked;
      }
      
      // Initial state
      updateBulkEditButton();
    }
  });
</script>
