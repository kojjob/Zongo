<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <div class="flex items-center">
      <%= link_to transactions_path, class: "flex items-center justify-center w-10 h-10 rounded-full bg-lime-100 text-lime-600 hover:bg-lime-200 transition-colors mr-3" do %>
        <%= icon "arrow-left", class: "w-5 h-5" %>
      <% end %>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
        New <%= @transaction_type.capitalize %> Transaction
      </h1>
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
    <div class="<%= transaction_type_header_class(@transaction_type) %>">
      <div class="p-6">
        <div class="flex items-center">
          <div class="<%= transaction_type_icon_class(@transaction_type) %>">
            <%= transaction_type_icon(@transaction_type) %>
          </div>
          <div class="ml-4">
            <h2 class="text-xl font-semibold text-white"><%= transaction_type_title(@transaction_type) %></h2>
            <p class="text-white text-opacity-90">
              <%= transaction_type_description(@transaction_type) %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="p-6">
      <%= form_with(model: @transaction, url: transactions_path, local: true, class: "space-y-6") do |form| %>
        <%= form.hidden_field :transaction_type, value: @transaction_type %>

        <% case @transaction_type %>
        <% when 'deposit' %>
          <!-- Deposit Form Fields -->
          <div>
            <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount</label>
            <div class="mt-1 relative rounded-md shadow-sm">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="text-gray-500 sm:text-sm"><%= current_user.wallet.currency_symbol %></span>
              </div>
              <%= form.number_field :amount, step: '0.01', min: '0.01', required: true, class: "block w-full pl-7 pr-12 py-3 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

          <div>
            <label for="payment_method" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
            <div class="mt-1">
              <%= form.select :payment_method, payment_method_options, {}, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

          <div>
            <label for="provider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Provider</label>
            <div class="mt-1">
              <%= form.select :provider, provider_options_for(@transaction_type), {}, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

        <% when 'withdrawal' %>
          <!-- Withdrawal Form Fields -->
          <div>
            <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount</label>
            <div class="mt-1 relative rounded-md shadow-sm">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="text-gray-500 sm:text-sm"><%= current_user.wallet.currency_symbol %></span>
              </div>
              <%= form.number_field :amount, step: '0.01', min: '0.01', max: current_user.wallet.balance, required: true, class: "block w-full pl-7 pr-12 py-3 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Available balance: <%= current_user.wallet.currency_symbol %><%= number_with_delimiter(current_user.wallet.balance, delimiter: ',') %></p>
          </div>

          <div>
            <label for="payment_method" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
            <div class="mt-1">
              <%= form.select :payment_method, payment_method_options, {}, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

          <div>
            <label for="provider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Provider</label>
            <div class="mt-1">
              <%= form.select :provider, provider_options_for(@transaction_type), {}, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Destination Details</label>
            <div class="mt-1">
              <%= form.fields_for :destination do |destination_form| %>
                <div class="space-y-3">
                  <div>
                    <label for="destination_phone_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number (for Mobile Money)</label>
                    <%= destination_form.telephone_field :phone_number, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
                  </div>
                  <div>
                    <label for="destination_account_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Account Number (for Bank Transfer)</label>
                    <%= destination_form.text_field :account_number, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
                  </div>
                  <div>
                    <label for="destination_account_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Account Name (for Bank Transfer)</label>
                    <%= destination_form.text_field :account_name, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

        <% when 'transfer' %>
          <!-- Transfer Form Fields -->
          <div>
            <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount</label>
            <div class="mt-1 relative rounded-md shadow-sm">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="text-gray-500 sm:text-sm"><%= current_user.wallet.currency_symbol %></span>
              </div>
              <%= form.number_field :amount, step: '0.01', min: '0.01', max: current_user.wallet.balance, required: true, class: "block w-full pl-7 pr-12 py-3 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Available balance: <%= current_user.wallet.currency_symbol %><%= number_with_delimiter(current_user.wallet.balance, delimiter: ',') %></p>
          </div>

          <div>
            <label for="destination_wallet_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Recipient</label>
            <div class="mt-1">
              <%= form.select :destination_wallet_id, recipient_options, {}, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description (Optional)</label>
            <div class="mt-1">
              <%= form.text_area :description, rows: 3, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

        <% when 'payment' %>
          <!-- Payment Form Fields -->
          <div>
            <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount</label>
            <div class="mt-1 relative rounded-md shadow-sm">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="text-gray-500 sm:text-sm"><%= current_user.wallet.currency_symbol %></span>
              </div>
              <%= form.number_field :amount, step: '0.01', min: '0.01', max: current_user.wallet.balance, required: true, class: "block w-full pl-7 pr-12 py-3 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Available balance: <%= current_user.wallet.currency_symbol %><%= number_with_delimiter(current_user.wallet.balance, delimiter: ',') %></p>
          </div>

          <div>
            <label for="destination_wallet_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Merchant</label>
            <div class="mt-1">
              <%= form.select :destination_wallet_id, merchant_options, {}, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description (Optional)</label>
            <div class="mt-1">
              <%= form.text_area :description, rows: 3, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Details</label>
            <div class="mt-1">
              <%= form.fields_for :destination do |destination_form| %>
                <div class="space-y-3">
                  <div>
                    <label for="destination_reference" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Reference Number</label>
                    <%= destination_form.text_field :reference, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
                  </div>
                  <div>
                    <label for="destination_invoice_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Invoice Number (Optional)</label>
                    <%= destination_form.text_field :invoice_number, class: "block w-full py-3 px-4 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-lime-500 focus:border-lime-500" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="flex justify-end space-x-3">
          <%= link_to "Cancel", transactions_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-lime-500" %>
          <%= form.submit "Create Transaction", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-lime-600 hover:bg-lime-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-lime-500" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% content_for :helper_methods do %>
  <% # Helper methods for transaction form %>
  <%
    def transaction_type_header_class(type)
      case type
      when 'deposit'
        "bg-gradient-to-r from-green-500 to-green-600"
      when 'withdrawal'
        "bg-gradient-to-r from-red-500 to-red-600"
      when 'transfer'
        "bg-gradient-to-r from-blue-500 to-blue-600"
      when 'payment'
        "bg-gradient-to-r from-purple-500 to-purple-600"
      else
        "bg-gradient-to-r from-gray-500 to-gray-600"
      end
    end

    def transaction_type_icon_class(type)
      base_class = "w-12 h-12 rounded-full flex items-center justify-center"
      case type
      when 'deposit'
        "#{base_class} bg-green-100 text-green-600"
      when 'withdrawal'
        "#{base_class} bg-red-100 text-red-600"
      when 'transfer'
        "#{base_class} bg-blue-100 text-blue-600"
      when 'payment'
        "#{base_class} bg-purple-100 text-purple-600"
      else
        "#{base_class} bg-gray-100 text-gray-600"
      end
    end

    def transaction_type_icon(type)
      case type
      when 'deposit'
        icon("arrow-down-to-line", class: "w-6 h-6")
      when 'withdrawal'
        icon("arrow-up-from-line", class: "w-6 h-6")
      when 'transfer'
        icon("arrow-right-arrow-left", class: "w-6 h-6")
      when 'payment'
        icon("credit-card", class: "w-6 h-6")
      else
        icon("question-mark-circle", class: "w-6 h-6")
      end
    end

    def transaction_type_title(type)
      case type
      when 'deposit'
        "Deposit Money"
      when 'withdrawal'
        "Withdraw Money"
      when 'transfer'
        "Transfer Money"
      when 'payment'
        "Make a Payment"
      else
        "New Transaction"
      end
    end

    def transaction_type_description(type)
      case type
      when 'deposit'
        "Add money to your wallet from an external source."
      when 'withdrawal'
        "Withdraw money from your wallet to an external destination."
      when 'transfer'
        "Send money to another user's wallet."
      when 'payment'
        "Pay for goods or services."
      else
        "Create a new transaction."
      end
    end

    def payment_method_options
      [
        ['Mobile Money', 'mobile_money'],
        ['Bank Transfer', 'bank_transfer'],
        ['Card Payment', 'card_payment'],
        ['Cash', 'cash']
      ]
    end

    def provider_options_for(transaction_type)
      case transaction_type
      when 'deposit', 'withdrawal'
        [
          ['MTN Mobile Money', 'MTN'],
          ['Vodafone Cash', 'Vodafone'],
          ['AirtelTigo Money', 'AirtelTigo'],
          ['Ghana Commercial Bank', 'GCB'],
          ['Ecobank', 'Ecobank'],
          ['Fidelity Bank', 'Fidelity'],
          ['Visa', 'Visa'],
          ['Mastercard', 'Mastercard']
        ]
      else
        [
          ['Select Provider', '']
        ]
      end
    end

    def recipient_options
      # In a real application, this would fetch actual recipients
      # For now, we'll use dummy data
      [
        ['John Doe (Wallet ID: 12345)', 1],
        ['Jane Smith (Wallet ID: 67890)', 2],
        ['Kwame Nkrumah (Wallet ID: 24680)', 3]
      ]
    end

    def merchant_options
      # In a real application, this would fetch actual merchants
      # For now, we'll use dummy data
      [
        ['Ghana Water Company', 4],
        ['Electricity Company of Ghana', 5],
        ['MTN Ghana', 6],
        ['Vodafone Ghana', 7]
      ]
    end
  %>
<% end %>
