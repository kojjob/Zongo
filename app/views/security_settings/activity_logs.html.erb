<%# Security Activity Logs Page %>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex items-center mb-6">
    <a href="<%= security_settings_path %>" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 mr-2">
      <%= icon "arrow-left", class: "w-5 h-5" %>
    </a>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Security Activity Logs</h1>
  </div>

  <%# Activity Filters %>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
    <%= form_with url: security_activity_logs_path, method: :get, class: "space-y-4" do |f| %>
      <div class="flex flex-col md:flex-row md:items-end md:space-x-4">
        <div class="w-full md:w-1/3 mb-4 md:mb-0">
          <label for="event_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Event Type</label>
          <%= f.select :event_type, 
              [
                ['All Events', ''],
                ['Login Attempts', 'login_attempt'],
                ['Login Success', 'login_success'],
                ['Login Failures', 'login_failure'],
                ['Password Changes', 'password_change'],
                ['Account Locks', 'account_locked'],
                ['Transaction Checks', 'transaction_check'],
                ['Transaction Blocks', 'transaction_blocked'],
                ['Suspicious Activity', 'suspicious_activity'],
                ['Device Changes', 'device_change'],
                ['Verification', 'verification_success,verification_failure']
              ],
              { selected: params[:event_type] },
              { class: "block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-primary-500 focus:border-primary-500" }
          %>
        </div>
        
        <div class="w-full md:w-1/3 mb-4 md:mb-0">
          <label for="severity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Severity</label>
          <%= f.select :severity, 
              [
                ['All Severities', ''],
                ['Info', 'info'],
                ['Warning', 'warning'],
                ['Critical', 'critical']
              ],
              { selected: params[:severity] },
              { class: "block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-primary-500 focus:border-primary-500" }
          %>
        </div>
        
        <div class="w-full md:w-1/3">
          <button type="submit" class="btn btn-primary w-full">
            <%= icon "filter", class: "w-4 h-4 mr-1" %>
            Apply Filters
          </button>
        </div>
      </div>
    <% end %>
  </div>
  
  <%# Activity Logs Table %>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 dark:bg-gray-700">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Event</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date & Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">IP Address</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Device</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Severity</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Details</th>
          </tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
          <% if @logs.empty? %>
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                No activity logs found
              </td>
            </tr>
          <% else %>
            <% @logs.each do |log| %>
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <% 
                      icon_name = case log.event_type
                                  when 'login_attempt', 'login_success' then 'log-in'
                                  when 'login_failure' then 'alert-triangle'
                                  when 'password_change' then 'key'
                                  when 'account_locked' then 'lock'
                                  when 'transaction_check', 'transaction_blocked' then 'credit-card'
                                  when 'suspicious_activity' then 'alert-octagon'
                                  when 'ip_change', 'device_change' then 'smartphone'
                                  when 'verification_success', 'verification_failure' then 'shield'
                                  else 'activity'
                                  end
                      
                      icon_color = case log.severity
                                   when 'info' then 'text-blue-500'
                                   when 'warning' then 'text-yellow-500'
                                   when 'critical' then 'text-red-500'
                                   end
                    %>
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center <%= icon_color %>">
                      <%= icon icon_name, class: "h-4 w-4" %>
                    </div>
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900 dark:text-white">
                        <%= log.event_type.humanize %>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900 dark:text-white">
                    <%= log.created_at.strftime("%b %d, %Y") %>
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">
                    <%= log.created_at.strftime("%I:%M %p") %>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900 dark:text-white">
                    <%= log.ip_address.present? ? log.ip_address : "Unknown" %>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900 dark:text-white">
                    <% if log.user_agent.present? %>
                      <span title="<%= log.user_agent %>">
                        <%= log.user_agent.truncate(30) %>
                      </span>
                    <% else %>
                      Unknown
                    <% end %>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% 
                    severity_class = case log.severity
                                     when 'info' then 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'
                                     when 'warning' then 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'
                                     when 'critical' then 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'
                                     end
                  %>
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <%= severity_class %>">
                    <%= log.severity.capitalize %>
                  </span>
                </td>
                <td class="px-6 py-4">
                  <% if log.details.present? %>
                    <button type="button" class="text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-300" data-action="click->modal#open" data-modal-target="log-details-<%= log.id %>-modal">
                      View Details
                    </button>
                    
                    <div id="log-details-<%= log.id %>-modal" class="modal" data-controller="modal">
                      <div class="modal-backdrop" data-action="click->modal#close"></div>
                      <div class="modal-container">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h3 class="modal-title"><%= log.event_type.humanize %> Details</h3>
                            <button type="button" class="modal-close" data-action="modal#close">&times;</button>
                          </div>
                          <div class="modal-body">
                            <dl class="divide-y divide-gray-200 dark:divide-gray-700">
                              <% log.details.each do |key, value| %>
                                <div class="py-3 grid grid-cols-3 gap-4">
                                  <dt class="text-sm font-medium text-gray-700 dark:text-gray-300"><%= key.to_s.humanize %></dt>
                                  <dd class="text-sm text-gray-900 dark:text-white col-span-2"><%= value.to_s %></dd>
                                </div>
                              <% end %>
                              <div class="py-3 grid grid-cols-3 gap-4">
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">IP Address</dt>
                                <dd class="text-sm text-gray-900 dark:text-white col-span-2"><%= log.ip_address || "Unknown" %></dd>
                              </div>
                              <div class="py-3 grid grid-cols-3 gap-4">
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">User Agent</dt>
                                <dd class="text-sm text-gray-900 dark:text-white col-span-2 break-all"><%= log.user_agent || "Unknown" %></dd>
                              </div>
                              <div class="py-3 grid grid-cols-3 gap-4">
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Timestamp</dt>
                                <dd class="text-sm text-gray-900 dark:text-white col-span-2"><%= log.created_at.strftime("%B %d, %Y at %I:%M:%S %p") %></dd>
                              </div>
                            </dl>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-action="modal#close">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% else %>
                    <span class="text-gray-500 dark:text-gray-400">No details</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
    
    <% if @logs.any? %>
      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
        <%== pagy_nav(@pagy) %>
      </div>
    <% end %>
  </div>
</div>