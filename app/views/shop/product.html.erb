<%# Product Detail Header Section %>
<div class="bg-white dark:bg-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2">
        <li>
          <div>
            <a href="<%= root_path %>" class="text-gray-400 dark:text-gray-500 hover:text-gray-500 dark:hover:text-gray-400">
              <svg class="flex-shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
              </svg>
              <span class="sr-only">Home</span>
            </a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="flex-shrink-0 h-5 w-5 text-gray-300 dark:text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
            </svg>
            <a href="<%= shop_path %>" class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">Shop</a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="flex-shrink-0 h-5 w-5 text-gray-300 dark:text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
            </svg>
            <a href="<%= shop_category_path(@product.shop_category.slug) %>" class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
              <%= @product.shop_category.name %>
            </a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="flex-shrink-0 h-5 w-5 text-gray-300 dark:text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
            </svg>
            <span class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400" aria-current="page"><%= @product.name %></span>
          </div>
        </li>
      </ol>
    </nav>
  </div>

  <%# Product Detail Main Section %>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
    <div class="lg:grid lg:grid-cols-2 lg:gap-x-8">
      <%# Enhanced Product Image Gallery %>
      <div class="lg:max-w-lg lg:self-start" data-controller="product-gallery">
        <div class="rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800 mb-4 relative">
          <%# Product Badges %>
          <div class="absolute top-0 left-0 z-10 flex flex-col items-start space-y-2 p-4">
            <% if @product.created_at > 30.days.ago %>
              <span class="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-md shadow-md">NEW</span>
            <% end %>
            <% if @product.respond_to?(:featured?) && @product.featured? %>
              <span class="bg-yellow-500 text-white text-xs font-bold px-3 py-1 rounded-md shadow-md mt-2">FEATURED</span>
            <% end %>
          </div>

          <%# Sale Badge %>
          <% if @product.on_sale? %>
            <div class="absolute top-0 right-0 z-10 m-4">
              <div class="bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-md shadow-md transform rotate-3 hover:rotate-0 transition-transform duration-300">
                <%= @product.discount_percentage %>% OFF
              </div>
            </div>
          <% end %>

          <%# Main Image with Zoom Lens %>
          <div id="main-image-container" class="relative h-96 w-full overflow-hidden"
               data-product-gallery-target="mainContainer"
               data-action="mousemove->product-gallery#handleZoom mouseenter->product-gallery#showZoomLens mouseleave->product-gallery#hideZoomLens click->product-gallery#openLightbox">
            <% if @product.images.attached? %>
              <%= image_tag @product.images.first, class: "w-full h-full object-center object-cover cursor-zoom-in",
                           id: "featured-image",
                           data: { product_gallery_target: "mainImage" } %>

              <%# Zoom Lens %>
              <div class="hidden absolute border-2 border-primary-500 bg-white bg-opacity-20 pointer-events-none"
                   data-product-gallery-target="zoomLens"></div>

              <%# Zoomed Result %>
              <div class="hidden absolute top-0 right-0 transform translate-x-full border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-xl rounded-md overflow-hidden"
                   style="width: 300px; height: 300px;"
                   data-product-gallery-target="zoomResult"></div>
            <% else %>
              <div class="w-full h-full flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
            <% end %>
          </div>

          <%# Image Counter for Mobile %>
          <% if @product.images.attached? && @product.images.count > 1 %>
            <div class="absolute bottom-4 right-4 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-full md:hidden">
              <span data-product-gallery-target="counter">1</span> / <%= @product.images.count %>
            </div>

            <%# Mobile Navigation Arrows %>
            <button class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full md:hidden focus:outline-none"
                    data-action="click->product-gallery#previousImage">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <button class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full md:hidden focus:outline-none"
                    data-action="click->product-gallery#nextImage">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          <% end %>
        </div>

        <%# Thumbnails Gallery - Hidden on Mobile %>
        <% if @product.images.attached? && @product.images.count > 1 %>
          <div class="hidden md:grid grid-cols-5 gap-2 mt-2" data-product-gallery-target="thumbnails">
            <% @product.images.each_with_index do |image, index| %>
              <button class="thumbnail-btn rounded-md overflow-hidden bg-gray-100 dark:bg-gray-800 transition-all duration-200 <%= index == 0 ? 'ring-2 ring-primary-500' : 'hover:ring-2 hover:ring-primary-300' %>"
                      data-index="<%= index %>"
                      data-src="<%= url_for(image) %>"
                      data-action="click->product-gallery#selectImage">
                <%= image_tag image, class: "w-full h-20 object-center object-cover" %>
              </button>
            <% end %>
          </div>
        <% end %>

        <%# Lightbox Gallery %>
        <div class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center"
             data-product-gallery-target="lightbox">
          <div class="relative w-full h-full flex flex-col">
            <%# Close Button %>
            <button class="absolute top-4 right-4 text-white p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 focus:outline-none z-10"
                    data-action="click->product-gallery#closeLightbox">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            <%# Main Lightbox Image %>
            <div class="flex-1 flex items-center justify-center p-4">
              <img data-product-gallery-target="lightboxImage"
                   src="<%= @product.images.attached? ? url_for(@product.images.first) : '' %>"
                   class="max-h-full max-w-full object-contain mx-auto" />
            </div>

            <%# Lightbox Navigation %>
            <% if @product.images.attached? && @product.images.count > 1 %>
              <div class="p-4">
                <div class="flex justify-between items-center">
                  <button class="text-white p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 focus:outline-none"
                          data-action="click->product-gallery#previousLightboxImage">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>

                  <div class="text-white text-sm">
                    <span data-product-gallery-target="lightboxCounter">1</span> / <%= @product.images.count %>
                  </div>

                  <button class="text-white p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 focus:outline-none"
                          data-action="click->product-gallery#nextLightboxImage">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>

                <%# Lightbox Thumbnails %>
                <div class="mt-4 grid grid-cols-8 gap-2">
                  <% @product.images.each_with_index do |image, index| %>
                    <button class="rounded-md overflow-hidden bg-gray-800 transition-all duration-200 <%= index == 0 ? 'ring-2 ring-primary-500' : '' %>"
                            data-index="<%= index %>"
                            data-src="<%= url_for(image) %>"
                            data-action="click->product-gallery#selectLightboxImage">
                      <%= image_tag image, class: "w-full h-12 object-center object-cover" %>
                    </button>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <%# Enhanced Product Information %>
      <div class="mt-10 lg:mt-0 lg:col-start-2 lg:row-span-2 lg:self-start">
        <div class="flex flex-col h-full">
          <div class="flex-1">
            <%# Product Title with SKU %>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
              <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 dark:text-white"><%= @product.name %></h1>
              <p class="mt-1 sm:mt-0 text-sm text-gray-500 dark:text-gray-400">SKU: <%= @product.sku %></p>
            </div>

            <%# Enhanced Rating Display %>
            <div class="mt-3">
              <div class="flex items-center">
                <div class="flex items-center">
                  <% (1..5).each do |i| %>
                    <% if i <= @product.average_rating.round %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    <% else %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300 dark:text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    <% end %>
                  <% end %>
                </div>
                <a href="#reviews" class="ml-2 text-sm text-primary-600 dark:text-primary-400 hover:underline">
                  <%= @product.average_rating.round(1) %> (<%= @product.reviews.count %> reviews)
                </a>

                <%# Category Link %>
                <span class="mx-2 text-gray-300 dark:text-gray-600">|</span>
                <a href="<%= shop_category_path(@product.shop_category.slug) %>" class="text-sm text-primary-600 dark:text-primary-400 hover:underline">
                  <%= @product.shop_category.name %>
                </a>
              </div>
            </div>

            <%# Enhanced Price Display %>
            <div class="mt-4 bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
              <div class="flex items-baseline">
                <% if @product.on_sale? %>
                  <p class="text-lg text-gray-500 dark:text-gray-400 line-through mr-3">
                    GHS <%= @product.original_price %>
                  </p>
                  <p class="text-3xl font-bold text-red-600 dark:text-red-500">
                    <%= @product.formatted_price %>
                  </p>
                  <span class="ml-3 px-2 py-1 text-xs font-semibold text-red-800 dark:text-red-300 bg-red-100 dark:bg-red-900 rounded-md">
                    SAVE <%= @product.discount_percentage %>%
                  </span>
                <% else %>
                  <p class="text-3xl font-bold text-gray-900 dark:text-white">
                    <%= @product.formatted_price %>
                  </p>
                <% end %>
              </div>

              <%# Flash Sale Countdown if applicable %>
              <%
                # Check if product is part of an active flash sale
                active_flash_sale_item = @product.flash_sale_items.joins(:flash_sale)
                                                .where(flash_sales: { active: true })
                                                .where('flash_sales.starts_at <= ? AND flash_sales.ends_at >= ?', Time.current, Time.current)
                                                .first
              %>
              <% if @product.on_sale? && active_flash_sale_item && active_flash_sale_item.flash_sale.ends_at > Time.current %>
                <div class="mt-2" data-controller="countdown" data-countdown-end-value="<%= active_flash_sale_item.flash_sale.ends_at.to_i %>">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Sale ends in:</p>
                  <div class="flex space-x-2 mt-1">
                    <div class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">
                      <span data-countdown-target="days" class="font-mono font-bold">00</span>
                      <span class="text-xs">days</span>
                    </div>
                    <div class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">
                      <span data-countdown-target="hours" class="font-mono font-bold">00</span>
                      <span class="text-xs">hrs</span>
                    </div>
                    <div class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">
                      <span data-countdown-target="minutes" class="font-mono font-bold">00</span>
                      <span class="text-xs">min</span>
                    </div>
                    <div class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">
                      <span data-countdown-target="seconds" class="font-mono font-bold">00</span>
                      <span class="text-xs">sec</span>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

            <%# Enhanced Stock Status %>
            <div class="mt-6">
              <div class="flex items-center">
                <% if @product.in_stock? %>
                  <% if @product.stock_quantity > 10 %>
                    <div class="flex-shrink-0 w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                    <p class="text-sm text-green-600 dark:text-green-400 font-medium">
                      In Stock
                    </p>
                    <span class="mx-2 text-gray-300 dark:text-gray-600">|</span>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      Usually ships within 24 hours
                    </p>
                  <% elsif @product.stock_quantity > 0 %>
                    <div class="flex-shrink-0 w-2 h-2 rounded-full bg-yellow-500 mr-2"></div>
                    <p class="text-sm text-yellow-600 dark:text-yellow-400 font-medium">
                      Low Stock
                    </p>
                    <span class="mx-2 text-gray-300 dark:text-gray-600">|</span>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      Only <%= @product.stock_quantity %> left
                    </p>
                  <% end %>
                <% else %>
                  <div class="flex-shrink-0 w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                  <p class="text-sm text-red-600 dark:text-red-400 font-medium">
                    Out of Stock
                  </p>
                  <span class="mx-2 text-gray-300 dark:text-gray-600">|</span>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    Check back later
                  </p>
                <% end %>
              </div>
            </div>

            <%# Product Description %>
            <div class="mt-6">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Description</h3>
              <div class="mt-2 prose prose-sm max-w-none text-gray-700 dark:text-gray-300">
                <%= @product.description %>
              </div>
            </div>

            <%# Key Features %>
            <% if @product.respond_to?(:features) && @product.features.present? && @product.features.any? %>
              <div class="mt-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Key Features</h3>
                <ul class="mt-2 space-y-2">
                  <% @product.features.each do |feature| %>
                    <li class="flex items-start">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                      <span class="text-gray-700 dark:text-gray-300"><%= feature %></span>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <%# Enhanced Specifications with Accordion %>
            <% if @product.specifications.present? && @product.specifications.any? %>
              <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6" data-controller="accordion">
                <button class="flex w-full justify-between items-center text-lg font-medium text-gray-900 dark:text-white focus:outline-none"
                        data-action="accordion#toggle">
                  <span>Specifications</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 transition-transform duration-200"
                       data-accordion-target="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="mt-4 grid grid-cols-1 gap-x-6 gap-y-4 sm:grid-cols-2 overflow-hidden transition-all duration-300 max-h-0"
                     data-accordion-target="content">
                  <% @product.specifications.each do |key, value| %>
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-md">
                      <dt class="text-sm font-medium text-gray-500 dark:text-gray-400"><%= key.to_s.titleize %></dt>
                      <dd class="mt-1 text-sm text-gray-900 dark:text-white"><%= value %></dd>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <%# Social Sharing %>
            <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
              <h3 class="text-sm font-medium text-gray-900 dark:text-white">Share this product</h3>
              <div class="mt-2 flex space-x-4">
                <a href="https://www.facebook.com/sharer/sharer.php?u=<%= request.original_url %>" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-500">
                  <span class="sr-only">Facebook</span>
                  <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" />
                  </svg>
                </a>
                <a href="https://twitter.com/intent/tweet?url=<%= request.original_url %>&text=<%= @product.name %>" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-400">
                  <span class="sr-only">Twitter</span>
                  <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" />
                  </svg>
                </a>
                <a href="https://wa.me/?text=<%= @product.name %>%20<%= request.original_url %>" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-green-500">
                  <span class="sr-only">WhatsApp</span>
                  <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill-rule="evenodd" d="M20.11 3.89C17.95 1.72 15.04 0.5 11.99 0.5C5.67 0.5 0.5 5.67 0.5 12C0.5 14.03 1.01 16.01 2 17.77L0.5 23.5L6.39 22.01C8.1 22.92 10.02 23.38 11.99 23.38C18.31 23.38 23.5 18.21 23.5 11.88C23.5 8.83 22.27 5.92 20.11 3.89ZM11.99 21.49C10.22 21.49 8.49 21.05 6.96 20.22L6.58 19.99L3.11 20.88L4.01 17.5L3.75 17.1C2.83 15.51 2.33 13.69 2.33 11.8C2.33 6.67 6.67 2.33 11.99 2.33C14.54 2.33 16.96 3.35 18.75 5.14C20.54 6.93 21.67 9.35 21.67 11.9C21.67 17.03 17.32 21.49 11.99 21.49ZM17.08 14.51C16.79 14.37 15.38 13.67 15.12 13.58C14.86 13.49 14.67 13.44 14.48 13.73C14.29 14.02 13.73 14.67 13.58 14.86C13.42 15.06 13.27 15.08 12.98 14.94C12.69 14.8 11.78 14.51 10.72 13.56C9.89 12.82 9.35 11.91 9.19 11.62C9.04 11.33 9.18 11.19 9.31 11.06C9.42 10.94 9.57 10.76 9.69 10.6C9.82 10.44 9.87 10.33 9.96 10.13C10.05 9.94 10 9.78 9.94 9.64C9.87 9.5 9.33 8.09 9.09 7.51C8.86 6.94 8.62 7.02 8.45 7.01C8.29 7 8.1 7 7.91 7C7.72 7 7.41 7.07 7.15 7.36C6.89 7.65 6.14 8.35 6.14 9.76C6.14 11.17 7.19 12.53 7.32 12.72C7.45 12.91 9.33 15.81 12.21 17.04C12.99 17.38 13.59 17.58 14.06 17.73C14.83 17.98 15.53 17.95 16.09 17.88C16.72 17.8 17.87 17.18 18.11 16.5C18.35 15.82 18.35 15.24 18.28 15.13C18.21 15.02 18.02 14.95 17.73 14.81C17.44 14.67 16.03 13.97 15.77 13.88C15.51 13.79 15.32 13.74 15.13 14.03C14.94 14.32 14.38 14.95 14.22 15.14C14.06 15.33 13.91 15.36 13.62 15.22C13.33 15.08 12.42 14.79 11.36 13.84C10.53 13.1 9.99 12.19 9.83 11.9C9.67 11.61 9.81 11.47 9.94 11.34C10.06 11.22 10.21 11.04 10.33 10.88C10.45 10.72 10.5 10.61 10.59 10.42C10.68 10.23 10.63 10.07 10.57 9.93C10.5 9.79 9.98 8.38 9.69 7.74" clip-rule="evenodd" />
                  </svg>
                </a>
                <button class="text-gray-400 hover:text-gray-600 focus:outline-none"
                        onclick="navigator.clipboard.writeText(window.location.href); alert('Link copied to clipboard!');">
                  <span class="sr-only">Copy Link</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <%# Enhanced Add to Cart Section %>
          <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-8" data-controller="product-purchase">
            <%= form_with url: add_to_cart_path, method: :post, class: "mt-6", data: { action: "submit->product-purchase#addToCart" } do %>
              <%= hidden_field_tag :product_id, @product.id %>

              <%# Quantity Selector with Improved UI %>
              <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                  <label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Quantity</label>
                  <% if @product.in_stock? %>
                    <span class="text-xs text-gray-500 dark:text-gray-400">
                      <%= @product.stock_quantity %> available
                    </span>
                  <% end %>
                </div>

                <div class="flex items-center">
                  <div class="flex rounded-md shadow-sm flex-1">
                    <button type="button"
                            class="relative inline-flex items-center justify-center w-12 h-12 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-l-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500"
                            data-action="click->product-purchase#decreaseQuantity"
                            <%= 'disabled' unless @product.in_stock? %>>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                      </svg>
                    </button>

                    <%= number_field_tag :quantity, 1,
                                        min: 1,
                                        max: @product.stock_quantity,
                                        class: "flex-1 min-w-0 block w-full px-3 py-3 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500 text-center font-medium text-lg",
                                        data: {
                                          product_purchase_target: "quantity",
                                          action: "change->product-purchase#updateTotal input->product-purchase#validateQuantity",
                                          price: @product.price
                                        },
                                        disabled: !@product.in_stock? %>

                    <button type="button"
                            class="relative inline-flex items-center justify-center w-12 h-12 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-r-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500"
                            data-action="click->product-purchase#increaseQuantity"
                            <%= 'disabled' unless @product.in_stock? %>>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                      </svg>
                    </button>
                  </div>

                  <%# Wishlist Button %>
                  <button type="button"
                          class="ml-4 inline-flex items-center justify-center p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                          data-action="product-purchase#toggleWishlist"
                          data-product-purchase-target="wishlistButton">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                  </button>
                </div>

                <%# Volume Pricing if applicable - Commented out until implemented in the model %>
                <%# Volume pricing will be implemented in a future update
                  <div class="mt-3 bg-gray-50 dark:bg-gray-800 rounded-md p-3">
                    <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">Volume Pricing:</p>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                      <div class="flex flex-col items-center p-1 rounded bg-white dark:bg-gray-700">
                        <span class="font-medium">10+ units</span>
                        <span class="text-primary-600 dark:text-primary-400">GHS 95.00</span>
                      </div>
                      <div class="flex flex-col items-center p-1 rounded bg-white dark:bg-gray-700">
                        <span class="font-medium">25+ units</span>
                        <span class="text-primary-600 dark:text-primary-400">GHS 90.00</span>
                      </div>
                      <div class="flex flex-col items-center p-1 rounded bg-white dark:bg-gray-700">
                        <span class="font-medium">50+ units</span>
                        <span class="text-primary-600 dark:text-primary-400">GHS 85.00</span>
                      </div>
                    </div>
                  </div>
                %>
              </div>

              <%# Total and Add to Cart Button %>
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="bg-gray-50 dark:bg-gray-800 px-4 py-3 rounded-md">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Total Price:</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-white" data-product-purchase-target="totalPrice">
                    <%= @product.formatted_price %>
                  </p>
                </div>

                <div class="flex-1 flex">
                  <button type="submit"
                          class="<%= @product.in_stock? ? 'bg-primary-600 hover:bg-primary-700' : 'bg-gray-400 cursor-not-allowed' %> w-full py-4 px-8 border border-transparent rounded-md shadow-sm text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200 transform hover:scale-[1.02] flex items-center justify-center"
                          <%= 'disabled' unless @product.in_stock? %>
                          data-product-purchase-target="addToCartButton">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" />
                    </svg>
                    Add to Cart
                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-800 text-white" data-product-purchase-target="quantityBadge">1</span>
                  </button>
                </div>
              </div>

              <%# Buy Now Button %>
              <% if @product.in_stock? %>
                <div class="mt-3">
                  <button type="button"
                          class="w-full py-3 px-8 border border-primary-600 dark:border-primary-500 rounded-md shadow-sm text-base font-medium text-primary-600 dark:text-primary-400 bg-white dark:bg-gray-800 hover:bg-primary-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                          data-action="product-purchase#buyNow">
                    Buy Now
                  </button>
                </div>
              <% end %>
            <% end %>

            <%# Trust Badges %>
            <div class="mt-6 grid grid-cols-2 gap-4">
              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <p class="ml-2 text-sm text-gray-500 dark:text-gray-400">
                  Secure payment
                </p>
              </div>

              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
                <p class="ml-2 text-sm text-gray-500 dark:text-gray-400">
                  Zongo Pay accepted
                </p>
              </div>

              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                <p class="ml-2 text-sm text-gray-500 dark:text-gray-400">
                  Free shipping over GHS 100
                </p>
              </div>

              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <p class="ml-2 text-sm text-gray-500 dark:text-gray-400">
                  30-day returns
                </p>
              </div>
            </div>

            <%# Ask a Question Section %>
            <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6" data-controller="accordion">
              <button class="flex w-full justify-between items-center text-sm font-medium text-gray-900 dark:text-white focus:outline-none"
                      data-action="accordion#toggle">
                <span>Have a question about this product?</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 transition-transform duration-200"
                     data-accordion-target="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>

              <div class="mt-4 overflow-hidden transition-all duration-300 max-h-0"
                   data-accordion-target="content">
                <form class="space-y-4">
                  <div>
                    <label for="question" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Question</label>
                    <textarea id="question" rows="3" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
                  </div>

                  <div class="flex justify-end">
                    <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                      Submit Question
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <%# Sticky Add to Cart for Mobile %>
          <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 md:hidden z-40 shadow-lg"
               data-controller="sticky-cart"
               data-sticky-cart-product-id-value="<%= @product.id %>"
               data-sticky-cart-price-value="<%= @product.price %>">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Price:</p>
                <p class="text-lg font-bold text-gray-900 dark:text-white">
                  <%= @product.formatted_price %>
                </p>
              </div>

              <button type="button"
                      class="<%= @product.in_stock? ? 'bg-primary-600 hover:bg-primary-700' : 'bg-gray-400 cursor-not-allowed' %> inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                      <%= 'disabled' unless @product.in_stock? %>
                      data-action="sticky-cart#addToCart">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" />
                </svg>
                Add to Cart
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# Related Products Section %>
<div class="bg-gray-50 dark:bg-gray-800">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <h2 class="text-2xl font-extrabold tracking-tight text-gray-900 dark:text-white">Related Products</h2>
    <p class="mt-4 text-gray-500 dark:text-gray-400">Customers who viewed this item also viewed</p>

    <div class="mt-8 grid grid-cols-1 gap-y-12 sm:grid-cols-2 sm:gap-x-6 lg:grid-cols-4 xl:gap-x-8">
      <% @related_products.each do |product| %>
        <div class="group relative">
          <div class="relative w-full h-72 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
            <% if product.images.attached? %>
              <%= image_tag product.images.first, class: "w-full h-full object-center object-cover group-hover:opacity-75" %>
            <% else %>
              <div class="w-full h-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
            <% end %>
          </div>

          <h3 class="mt-4 text-base font-medium text-gray-900 dark:text-white">
            <a href="<%= product_path(product) %>">
              <span class="absolute inset-0"></span>
              <%= product.name %>
            </a>
          </h3>

          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400"><%= product.shop_category.name %></p>

          <div class="mt-1 flex items-center">
            <% (1..5).each do |i| %>
              <% if i <= product.average_rating.round %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              <% else %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-300 dark:text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              <% end %>
            <% end %>
          </div>

          <p class="mt-2 text-sm font-medium text-gray-900 dark:text-white"><%= product.formatted_price %></p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%# Reviews Section %>
<div class="bg-white dark:bg-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-extrabold tracking-tight text-gray-900 dark:text-white">Customer Reviews</h2>

      <% if user_signed_in? && current_user.orders.completed.joins(:order_items).where(order_items: { product_id: @product.id }).exists? %>
        <a href="<%= new_product_review_path(@product) %>" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
          Write a Review
        </a>
      <% end %>
    </div>

    <div class="mt-8 lg:grid lg:grid-cols-12 lg:gap-x-8">
      <div class="lg:col-span-4">
        <div class="flex items-center">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">
            <%= @product.average_rating.round(1) %> out of 5 stars
          </h3>
        </div>

        <div class="mt-3 flex items-center">
          <div class="flex items-center">
            <% (1..5).each do |i| %>
              <% if i <= @product.average_rating.round %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              <% else %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300 dark:text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              <% end %>
            <% end %>
          </div>
          <p class="ml-2 text-sm text-gray-500 dark:text-gray-400">Based on <%= @product.reviews.count %> reviews</p>
        </div>

        <div class="mt-6">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">Rating breakdown</h3>

          <div class="mt-3 space-y-3">
            <% (5.downto(1)).each do |rating| %>
              <% count = @product.reviews.where(rating: rating).count %>
              <% percentage = @product.reviews.count > 0 ? (count.to_f / @product.reviews.count * 100).round : 0 %>

              <div class="flex items-center text-sm">
                <div class="flex items-center flex-1">
                  <p class="w-12 text-gray-700 dark:text-gray-300"><%= rating %> stars</p>
                  <div class="ml-4 flex-1">
                    <div class="h-2 rounded-full bg-gray-200 dark:bg-gray-700">
                      <div class="h-2 rounded-full bg-yellow-400" style="width: <%= percentage %>%"></div>
                    </div>
                  </div>
                </div>
                <p class="ml-4 w-10 text-right text-sm text-gray-500 dark:text-gray-400"><%= percentage %>%</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="mt-12 lg:mt-0 lg:col-span-8">
        <div class="flow-root">
          <div class="-my-12 divide-y divide-gray-200 dark:divide-gray-700">
            <% if @reviews.any? %>
              <% @reviews.each do |review| %>
                <div class="py-12">
                  <div class="flex items-center">
                    <div class="flex-shrink-0">
                      <% if review.user.avatar.attached? %>
                        <%= image_tag review.user.avatar, class: "h-12 w-12 rounded-full" %>
                      <% else %>
                        <div class="h-12 w-12 rounded-full bg-primary-600 flex items-center justify-center text-white font-bold">
                          <%= review.user.initials %>
                        </div>
                      <% end %>
                    </div>

                    <div class="ml-4">
                      <h4 class="text-sm font-bold text-gray-900 dark:text-white"><%= review.user.username %></h4>
                      <div class="mt-1 flex items-center">
                        <% (1..5).each do |i| %>
                          <% if i <= review.rating %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                          <% else %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-300 dark:text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                          <% end %>
                        <% end %>
                      </div>
                      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                        <%= time_ago_in_words(review.created_at) %> ago
                      </p>
                    </div>
                  </div>

                  <div class="mt-4 space-y-6 text-base text-gray-600 dark:text-gray-300">
                    <p><%= review.comment %></p>
                  </div>

                  <% if review.user == current_user %>
                    <div class="mt-4 flex space-x-4">
                      <%= link_to "Edit", edit_product_review_path(@product, review), class: "text-sm text-primary-600 dark:text-primary-400 hover:text-primary-500 dark:hover:text-primary-300" %>
                      <%= button_to "Delete", product_review_path(@product, review), method: :delete, class: "text-sm text-red-600 dark:text-red-400 hover:text-red-500 dark:hover:text-red-300", data: { confirm: "Are you sure you want to delete this review?" } %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="py-12 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No reviews yet</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Be the first to review this product.</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# JavaScript for Image Gallery %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Image Gallery - Legacy code for browsers without Stimulus support
    // Note: This is a fallback and will be replaced by the Stimulus controller
    const mainImage = document.getElementById('featured-image');
    const zoomOverlay = document.getElementById('image-zoom-overlay');
    const zoomedImage = document.getElementById('zoomed-image');
    const closeZoom = document.getElementById('close-zoom');
    const thumbnailButtons = document.querySelectorAll('.thumbnail-btn');

    // Set up thumbnail click handlers if not using Stimulus
    if (!window.Stimulus) {
      thumbnailButtons.forEach(button => {
        button.addEventListener('click', function() {
          const src = this.getAttribute('data-src');
          if (mainImage) mainImage.src = src;
          if (zoomedImage) zoomedImage.src = src;

          // Update active thumbnail
          thumbnailButtons.forEach(btn => btn.classList.remove('ring-2', 'ring-primary-500'));
          this.classList.add('ring-2', 'ring-primary-500');
        });
      });

      // Set up image zoom
      if (mainImage) {
        mainImage.addEventListener('click', function() {
          if (zoomOverlay) {
            zoomOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling when zoomed
          }
        });
      }

      if (closeZoom) {
        closeZoom.addEventListener('click', function() {
          zoomOverlay.classList.add('hidden');
          document.body.style.overflow = ''; // Restore scrolling
        });
      }
    }
  });
</script>