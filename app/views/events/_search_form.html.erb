<%= content_for :page_title, "Events" %>
<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 border border-indigo-100 dark:border-indigo-900/30 mb-8 hover:shadow-xl transition-shadow duration-300 relative overflow-hidden" data-controller="search-animation">
  <!-- Decorative elements -->
  <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 rounded-full -mt-32 -mr-32 dark:from-indigo-500/10 dark:to-purple-500/10"></div>
  <div class="absolute bottom-0 left-0 w-64 h-64 bg-gradient-to-tr from-blue-500/5 to-cyan-500/5 rounded-full -mb-32 -ml-32 dark:from-blue-500/10 dark:to-cyan-500/10"></div>

  <%= form_with url: events_path, method: :get, data: { controller: "search", turbo_frame: "events_results", loading_state_controller: "loading-state" } do |f| %>
    <div class="flex flex-col space-y-6 relative">
      <!-- Enhanced Search Bar with animation -->
      <div class="relative" data-search-animation-target="searchBox">
        <label for="query" class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
          <%= icon "search", class: "w-4 h-4 mr-2 text-indigo-500 dark:text-indigo-400" %>
          Search Events
        </label>
        <div class="relative rounded-xl shadow-md">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <%= icon "search", class: "h-5 w-5 text-indigo-500 dark:text-indigo-400" %>
          </div>
          <%= f.text_field :query,
              placeholder: "Search events, venues, categories...",
              class: "pl-12 pr-4 py-4 bg-white dark:bg-gray-700 border-2 border-indigo-200 dark:border-indigo-800 rounded-xl w-full text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500 dark:focus:ring-indigo-400 dark:focus:border-indigo-400 shadow-sm transition-all",
              data: {
                action: "input->search#debounce focus->search-animation#expandSearchBox blur->search-animation#collapseSearchBox",
                search_animation_target: "searchInput"
              } %>
          <% if params[:query].present? %>
            <%= link_to events_path(params.except(:query)), class: "absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-500 transition-colors", data: { turbo_frame: "events_results" } do %>
              <div class="bg-gray-100 dark:bg-gray-600 rounded-full p-1.5 hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors">
                <%= icon "x", class: "h-4 w-4" %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Enhanced Filters Section with visual cues -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
        <!-- Enhanced Date Range Filter -->
        <div class="relative">
          <label for="date_range" class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
            <%= icon "calendar", class: "w-4 h-4 mr-2 text-blue-500 dark:text-blue-400" %>
            Date Range
          </label>
          <div class="relative rounded-xl shadow-md">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <%= icon "calendar", class: "h-5 w-5 text-blue-500 dark:text-blue-400" %>
            </div>
            <%= f.select :date_range,
                options_for_select([
                  ["Any Date", ""],
                  ["Today", "today"],
                  ["Tomorrow", "tomorrow"],
                  ["This Weekend", "weekend"],
                  ["This Week", "week"],
                  ["This Month", "month"]
                ], params[:date_range]),
                {},
                class: "block w-full pl-12 pr-10 py-3.5 bg-white dark:bg-gray-700 border-2 border-blue-200 dark:border-blue-800 rounded-xl shadow-sm text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-400 dark:focus:border-blue-400 appearance-none transition-colors",
                data: { action: "change->search#submit" } %>
            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
              <div class="bg-blue-100 dark:bg-blue-900/30 rounded-full p-1">
                <%= icon "chevron-down", class: "h-4 w-4 text-blue-500 dark:text-blue-400" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Category Filter -->
        <div class="relative">
          <label for="category_id" class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
            <%= icon "tag", class: "w-4 h-4 mr-2 text-purple-500 dark:text-purple-400" %>
            Category
          </label>
          <div class="relative rounded-xl shadow-md">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <%= icon "tag", class: "h-5 w-5 text-purple-500 dark:text-purple-400" %>
            </div>
            <%= f.select :category_id,
                options_for_select([["All Categories", ""]] + @categories.map { |c| [c.name, c.id] }, params[:category_id]),
                {},
                class: "block w-full pl-12 pr-10 py-3.5 bg-white dark:bg-gray-700 border-2 border-purple-200 dark:border-purple-800 rounded-xl shadow-sm text-gray-900 dark:text-white focus:ring-purple-500 focus:border-purple-500 dark:focus:ring-purple-400 dark:focus:border-purple-400 appearance-none transition-colors",
                data: { action: "change->search#submit" } %>
            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
              <div class="bg-purple-100 dark:bg-purple-900/30 rounded-full p-1">
                <%= icon "chevron-down", class: "h-4 w-4 text-purple-500 dark:text-purple-400" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Price Filter -->
        <div class="relative">
          <label for="free_only" class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
            <%= icon "credit-card", class: "w-4 h-4 mr-2 text-green-500 dark:text-green-400" %>
            Price
          </label>
          <div class="relative rounded-xl shadow-md">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <%= icon "credit-card", class: "h-5 w-5 text-green-500 dark:text-green-400" %>
            </div>
            <%= f.select :free_only,
                options_for_select([
                  ["All Prices", "0"],
                  ["Free Only", "1"]
                ], params[:free_only]),
                {},
                class: "block w-full pl-12 pr-10 py-3.5 bg-white dark:bg-gray-700 border-2 border-green-200 dark:border-green-800 rounded-xl shadow-sm text-gray-900 dark:text-white focus:ring-green-500 focus:border-green-500 dark:focus:ring-green-400 dark:focus:border-green-400 appearance-none transition-colors",
                data: { action: "change->search#submit" } %>
            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
              <div class="bg-green-100 dark:bg-green-900/30 rounded-full p-1">
                <%= icon "chevron-down", class: "h-4 w-4 text-green-500 dark:text-green-400" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Sort Order -->
        <div class="relative">
          <label for="sort" class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
            <%= icon "bar-chart-2", class: "w-4 h-4 mr-2 text-pink-500 dark:text-pink-400" %>
            Sort By
          </label>
          <div class="relative rounded-xl shadow-md">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <%= icon "bar-chart-2", class: "h-5 w-5 text-pink-500 dark:text-pink-400" %>
            </div>
            <%= f.select :sort,
                options_for_select([
                  ["Upcoming First", "date_asc"],
                  ["Newest Added", "created_desc"],
                  ["Most Popular", "popularity"]
                ], params[:sort] || "date_asc"),
                {},
                class: "block w-full pl-12 pr-10 py-3.5 bg-white dark:bg-gray-700 border-2 border-pink-200 dark:border-pink-800 rounded-xl shadow-sm text-gray-900 dark:text-white focus:ring-pink-500 focus:border-pink-500 dark:focus:ring-pink-400 dark:focus:border-pink-400 appearance-none transition-colors",
                data: { action: "change->search#submit" } %>
            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
              <div class="bg-pink-100 dark:bg-pink-900/30 rounded-full p-1">
                <%= icon "chevron-down", class: "h-4 w-4 text-pink-500 dark:text-pink-400" %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Active Filters -->
      <% if params[:query].present? || params[:category_id].present? || params[:date_range].present? || params[:free_only] == "1" || params[:sort].present? && params[:sort] != "date_asc" %>
        <div class="flex flex-wrap gap-3 border-t border-gray-200 dark:border-gray-700 pt-5 mt-4">
          <div class="text-sm font-medium text-gray-600 dark:text-gray-400 mr-2 flex items-center">
            <%= icon "filter", class: "w-4 h-4 mr-1.5" %>
            Active Filters:
          </div>

          <% if params[:query].present? %>
            <div class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-200 shadow-sm border border-indigo-200 dark:border-indigo-900/30">
              <%= icon "search", class: "mr-1.5 h-4 w-4" %>
              <%= params[:query] %>
              <%= link_to events_path(params.permit(:category_id, :date_range, :free_only, :sort)), class: "ml-2 bg-white dark:bg-gray-800 rounded-full p-0.5 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 transition-colors", data: { turbo_frame: "events_results" } do %>
                <%= icon "x", class: "h-3 w-3" %>
              <% end %>
            </div>
          <% end %>

          <% if params[:category_id].present? %>
            <% category = @categories.find { |c| c.id.to_s == params[:category_id] } %>
            <div class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 shadow-sm border border-purple-200 dark:border-purple-900/30">
              <%= icon "tag", class: "mr-1.5 h-4 w-4" %>
              <%= category&.name || 'Unknown' %>
              <%= link_to events_path(params.permit(:query, :date_range, :free_only, :sort)), class: "ml-2 bg-white dark:bg-gray-800 rounded-full p-0.5 text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 transition-colors", data: { turbo_frame: "events_results" } do %>
                <%= icon "x", class: "h-3 w-3" %>
              <% end %>
            </div>
          <% end %>

          <% if params[:date_range].present? %>
            <div class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 shadow-sm border border-blue-200 dark:border-blue-900/30">
              <%= icon "calendar", class: "mr-1.5 h-4 w-4" %>
              <%= params[:date_range].titleize %>
              <%= link_to events_path(params.permit(:query, :category_id, :free_only, :sort)), class: "ml-2 bg-white dark:bg-gray-800 rounded-full p-0.5 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors", data: { turbo_frame: "events_results" } do %>
                <%= icon "x", class: "h-3 w-3" %>
              <% end %>
            </div>
          <% end %>

          <% if params[:free_only] == "1" %>
            <div class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 shadow-sm border border-green-200 dark:border-green-900/30">
              <%= icon "credit-card", class: "mr-1.5 h-4 w-4" %>
              Free Events Only
              <%= link_to events_path(params.permit(:query, :category_id, :date_range, :sort)), class: "ml-2 bg-white dark:bg-gray-800 rounded-full p-0.5 text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 transition-colors", data: { turbo_frame: "events_results" } do %>
                <%= icon "x", class: "h-3 w-3" %>
              <% end %>
            </div>
          <% end %>

          <% if params[:sort].present? && params[:sort] != "date_asc" %>
            <div class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-pink-100 dark:bg-pink-900/30 text-pink-800 dark:text-pink-200 shadow-sm border border-pink-200 dark:border-pink-900/30">
              <%= icon "bar-chart-2", class: "mr-1.5 h-4 w-4" %>
              <%= params[:sort] == "created_desc" ? "Newest Added" : "Most Popular" %>
              <%= link_to events_path(params.permit(:query, :category_id, :date_range, :free_only)), class: "ml-2 bg-white dark:bg-gray-800 rounded-full p-0.5 text-pink-600 dark:text-pink-400 hover:text-pink-800 dark:hover:text-pink-300 transition-colors", data: { turbo_frame: "events_results" } do %>
                <%= icon "x", class: "h-3 w-3" %>
              <% end %>
            </div>
          <% end %>

          <div class="ml-auto">
            <%= link_to events_path, class: "inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors shadow-sm border border-red-200 dark:border-red-900/30", data: { turbo_frame: "events_results" } do %>
              <%= icon "trash-2", class: "mr-1.5 h-4 w-4" %>
              Clear All Filters
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener("turbo:load", function() {
    // Register Stimulus controller for search box animation
    application.register("search-animation", class extends Stimulus.Controller {
      static targets = ["searchBox", "searchInput"]

      expandSearchBox() {
        this.searchBoxTarget.classList.add("ring-2", "ring-blue-500", "dark:ring-blue-400");
      }

      collapseSearchBox() {
        if (!this.searchInputTarget.value.trim()) {
          this.searchBoxTarget.classList.remove("ring-2", "ring-blue-500", "dark:ring-blue-400");
        }
      }
    });
  });
</script>
