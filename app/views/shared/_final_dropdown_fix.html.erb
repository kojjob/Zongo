<!-- FINAL DROPDOWN FIX - This overrides all other dropdown implementations -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”„ Applying FINAL dropdown fix...');

    // Find all dropdown buttons and menus
    const dropdownButtons = document.querySelectorAll('[data-dropdown-target="button"]');
    const dropdownMenus = document.querySelectorAll('[data-dropdown-target="menu"]');

    // Reset all dropdowns to a clean state
    dropdownMenus.forEach(menu => {
      // Remove all display-related classes and styles
      menu.style.display = 'none';
      menu.classList.remove('open', 'opacity-0', 'opacity-100', 'scale-95', 'scale-100', 'pointer-events-none', 'pointer-events-auto');

      // Ensure proper positioning
      if (menu.closest('.relative')) {
        // User dropdown
        menu.style.position = 'absolute';
        menu.style.top = '100%';
        menu.style.right = '0';
        menu.style.left = 'auto';
        menu.style.bottom = 'auto';
        menu.style.marginTop = '0.75rem';
        menu.style.zIndex = '9999';
      } else {
        // Shop/services dropdown
        menu.style.position = 'absolute';
        menu.style.top = '100%';
        menu.style.left = '0';
        menu.style.right = 'auto';
        menu.style.bottom = 'auto';
        menu.style.marginTop = '0.5rem';
        menu.style.zIndex = '9999';
      }
    });

    // Remove all existing click handlers by cloning and replacing
    dropdownButtons.forEach(button => {
      const newButton = button.cloneNode(true);
      button.parentNode.replaceChild(newButton, button);

      // Find the associated menu
      const container = newButton.closest('[data-controller="dropdown"]');
      if (!container) return;

      const menu = container.querySelector('[data-dropdown-target="menu"]');
      if (!menu) return;

      // Add new click handler
      newButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Close all other dropdowns
        dropdownMenus.forEach(otherMenu => {
          if (otherMenu !== menu && otherMenu.style.display !== 'none') {
            otherMenu.style.display = 'none';

            // Reset arrow if it exists
            const otherContainer = otherMenu.closest('[data-controller="dropdown"]');
            if (otherContainer) {
              const otherButton = otherContainer.querySelector('[data-dropdown-target="button"]');
              if (otherButton) {
                const arrow = otherButton.querySelector('[data-dropdown-target="arrow"]');
                if (arrow) {
                  arrow.style.transform = '';
                }
              }
            }
          }
        });

        // Toggle this dropdown
        if (menu.style.display === 'none') {
          menu.style.display = 'block';

          // Rotate arrow if it exists
          const arrow = newButton.querySelector('[data-dropdown-target="arrow"]');
          if (arrow) {
            arrow.style.transform = 'rotate(180deg)';
          }
        } else {
          menu.style.display = 'none';

          // Reset arrow if it exists
          const arrow = newButton.querySelector('[data-dropdown-target="arrow"]');
          if (arrow) {
            arrow.style.transform = '';
          }
        }
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      dropdownMenus.forEach(menu => {
        if (menu.style.display !== 'none') {
          const container = menu.closest('[data-controller="dropdown"]');
          if (container && !container.contains(e.target)) {
            menu.style.display = 'none';

            // Reset arrow if it exists
            const button = container.querySelector('[data-dropdown-target="button"]');
            if (button) {
              const arrow = button.querySelector('[data-dropdown-target="arrow"]');
              if (arrow) {
                arrow.style.transform = '';
              }
            }
          }
        }
      });
    });

    // Close dropdowns when pressing Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        dropdownMenus.forEach(menu => {
          menu.style.display = 'none';

          // Reset all arrows
          const arrows = document.querySelectorAll('[data-dropdown-target="arrow"]');
          arrows.forEach(arrow => {
            arrow.style.transform = '';
          });
        });
      }
    });

    console.log('âœ… FINAL dropdown fix applied successfully');
  });
</script>

<style>
  /* FINAL DROPDOWN FIX - This overrides all other dropdown styles */

  /* Reset all dropdown styles */
  [data-dropdown-target="menu"] {
    display: none !important;
    opacity: 1 !important;
    transform: none !important;
    pointer-events: auto !important;
    visibility: visible !important;
    transition: none !important;
    z-index: 9999 !important;
  }

  /* Only show when explicitly set to display:block by JavaScript */
  [data-dropdown-target="menu"][style*="display: block"] {
    display: block !important;
  }

  /* User dropdown specific positioning */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] {
    position: absolute !important;
    top: 100% !important;
    right: 0 !important;
    left: auto !important;
    bottom: auto !important;
    margin-top: 0.75rem !important;
    min-width: 18rem !important; /* 288px */
    padding: 0 !important; /* Remove padding to fix nested card appearance */
    border-radius: 1rem !important;
    background-color: white !important;
    border: 1px solid #e5e7eb !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
    overflow: hidden !important; /* Ensure content doesn't overflow */
  }

  /* Fix for the user dropdown background gradient */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] .bg-gradient-to-br {
    background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe) !important;
  }

  /* Fix for the user dropdown menu items container */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] .p-2 {
    padding: 0.5rem !important;
  }

  /* User dropdown specific text colors in light mode */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a,
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] button,
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] span,
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] p {
    color: #111827 !important; /* gray-900 */
  }

  /* User dropdown hover states in light mode */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a:hover,
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] button:hover {
    background-color: #f3f4f6 !important; /* gray-100 */
    border-radius: 0.5rem !important;
  }

  /* Enhance user dropdown menu items */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a,
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] button {
    display: flex !important;
    align-items: center !important;
    padding: 0.625rem 0.75rem !important;
    margin-bottom: 0.25rem !important;
    border-radius: 0.5rem !important;
    transition: all 0.2s ease !important;
  }

  /* Add colorful icons to user dropdown items */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a svg,
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] button svg {
    width: 1.25rem !important;
    height: 1.25rem !important;
    margin-right: 0.75rem !important;
  }

  /* Profile icon - blue */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="profile"] svg,
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="account"] svg {
    color: #3b82f6 !important; /* blue-500 */
  }

  /* Dashboard icon - purple */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="dashboard"] svg {
    color: #8b5cf6 !important; /* violet-500 */
  }

  /* Settings icon - gray */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="settings"] svg {
    color: #6b7280 !important; /* gray-500 */
  }

  /* Admin icon - red */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="admin"] svg {
    color: #ef4444 !important; /* red-500 */
  }

  /* Wallet icon - green */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="wallet"] svg {
    color: #10b981 !important; /* emerald-500 */
  }

  /* Sign out icon - orange */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] form[action*="sign_out"] button svg {
    color: #f97316 !important; /* orange-500 */
  }

  /* Add dividers between sections */
  .relative[data-controller="dropdown"] [data-dropdown-target="menu"] hr {
    margin: 0.5rem 0 !important;
    border-color: #e5e7eb !important;
  }

  /* Shop and Services dropdown positioning */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: auto !important;
    bottom: auto !important;
    margin-top: 0.5rem !important;
    min-width: 20rem !important;
    padding: 1rem !important;
    border-radius: 1rem !important;
    background-color: white !important;
    border: 1px solid #e5e7eb !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
  }

  /* Shop dropdown grid layout */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] .grid {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 1rem !important;
  }

  /* Shop dropdown category headers */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] h3 {
    font-weight: 600 !important;
    font-size: 0.875rem !important;
    color: #4b5563 !important; /* gray-600 */
    margin-bottom: 0.5rem !important;
  }

  /* Shop dropdown links */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a {
    display: flex !important;
    align-items: center !important;
    padding: 0.5rem !important;
    border-radius: 0.5rem !important;
    transition: all 0.2s ease !important;
    margin-bottom: 0.25rem !important;
  }

  /* Shop dropdown link hover */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a:hover {
    background-color: #f3f4f6 !important; /* gray-100 */
  }

  /* Shop dropdown icons */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a svg {
    width: 1.25rem !important;
    height: 1.25rem !important;
    margin-right: 0.75rem !important;
  }

  /* Colorful category icons in shop dropdown - light mode */
  /* Electronics - blue */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="electronics"] svg {
    color: #3b82f6 !important; /* blue-500 */
  }

  /* Clothing - purple */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="clothing"] svg,
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="fashion"] svg {
    color: #8b5cf6 !important; /* violet-500 */
  }

  /* Home - amber */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="home"] svg,
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="furniture"] svg {
    color: #f59e0b !important; /* amber-500 */
  }

  /* Food - green */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="food"] svg,
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="grocery"] svg {
    color: #10b981 !important; /* emerald-500 */
  }

  /* Beauty - pink */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="beauty"] svg,
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="health"] svg {
    color: #ec4899 !important; /* pink-500 */
  }

  /* Shop dropdown footer */
  .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] .bg-gray-50 {
    background-color: #f9fafb !important;
    margin: 0 -1rem -1rem -1rem !important;
    padding: 0.75rem 1rem !important;
    border-top: 1px solid #e5e7eb !important;
    border-radius: 0 0 1rem 1rem !important;
  }

  /* Dark mode fixes */
  .dark [data-dropdown-target="menu"] {
    background-color: #1f2937 !important;
    border-color: #374151 !important;
  }

  /* Shop dropdown dark mode fixes */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] {
    background-color: #1f2937 !important;
    border: 1px solid #374151 !important;
  }

  /* Shop dropdown dark mode category headers */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] h3 {
    color: #9ca3af !important; /* gray-400 */
  }

  /* Shop dropdown dark mode link hover */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a:hover {
    background-color: #374151 !important; /* gray-700 */
  }

  /* Shop dropdown dark mode footer */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] .bg-gray-50 {
    background-color: #111827 !important; /* gray-900 */
    border-top: 1px solid #374151 !important;
  }

  /* Colorful category icons in shop dropdown */
  /* Electronics - blue */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="electronics"] svg {
    color: #60a5fa !important; /* blue-400 */
  }

  /* Clothing - purple */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="clothing"] svg,
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="fashion"] svg {
    color: #a78bfa !important; /* violet-400 */
  }

  /* Home - amber */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="home"] svg,
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="furniture"] svg {
    color: #fbbf24 !important; /* amber-400 */
  }

  /* Food - green */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="food"] svg,
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="grocery"] svg {
    color: #34d399 !important; /* emerald-400 */
  }

  /* Beauty - pink */
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="beauty"] svg,
  .dark .dropdown-container[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="health"] svg {
    color: #f472b6 !important; /* pink-400 */
  }

  /* User dropdown specific dark mode fixes */
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] {
    background-color: #1f2937 !important;
    border: 1px solid #374151 !important;
  }

  /* Fix for the user dropdown background gradient in dark mode */
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] .bg-gradient-to-br {
    background: linear-gradient(to bottom right, #0f172a, #1e293b) !important;
  }

  /* Fix for the user dropdown pattern in dark mode */
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] .opacity-10 {
    opacity: 0.05 !important;
  }

  /* Fix for the user dropdown footer in dark mode */
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] .bg-gray-50 {
    background-color: #111827 !important;
  }

  /* Dark mode hover states for user dropdown */
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a:hover,
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] button:hover {
    background-color: #374151 !important;
  }

  /* Dark mode dividers */
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] hr {
    border-color: #374151 !important;
  }

  /* Keep colorful icons in dark mode */
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="profile"] svg,
  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="account"] svg {
    color: #60a5fa !important; /* blue-400 */
  }

  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="dashboard"] svg {
    color: #a78bfa !important; /* violet-400 */
  }

  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="settings"] svg {
    color: #9ca3af !important; /* gray-400 */
  }

  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="admin"] svg {
    color: #f87171 !important; /* red-400 */
  }

  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] a[href*="wallet"] svg {
    color: #34d399 !important; /* emerald-400 */
  }

  .dark .relative[data-controller="dropdown"] [data-dropdown-target="menu"] form[action*="sign_out"] button svg {
    color: #fb923c !important; /* orange-400 */
  }

  /* Force all text to be visible in dark mode */
  .dark [data-dropdown-target="menu"] * {
    color: #e5e7eb !important;
  }

  /* Specific text color overrides for dark mode */
  .dark [data-dropdown-target="menu"] a,
  .dark [data-dropdown-target="menu"] button,
  .dark [data-dropdown-target="menu"] span,
  .dark [data-dropdown-target="menu"] p,
  .dark [data-dropdown-target="menu"] div,
  .dark [data-dropdown-target="menu"] h1,
  .dark [data-dropdown-target="menu"] h2,
  .dark [data-dropdown-target="menu"] h3,
  .dark [data-dropdown-target="menu"] h4,
  .dark [data-dropdown-target="menu"] h5,
  .dark [data-dropdown-target="menu"] h6 {
    color: #e5e7eb !important;
  }

  /* Headings and bold text */
  .dark [data-dropdown-target="menu"] .text-gray-900,
  .dark [data-dropdown-target="menu"] .font-bold,
  .dark [data-dropdown-target="menu"] .font-semibold,
  .dark [data-dropdown-target="menu"] .font-medium {
    color: #ffffff !important;
  }

  /* Secondary text */
  .dark [data-dropdown-target="menu"] .text-gray-600,
  .dark [data-dropdown-target="menu"] .text-gray-500,
  .dark [data-dropdown-target="menu"] .text-gray-400 {
    color: #9ca3af !important;
  }

  /* Ensure links are clearly visible */
  .dark [data-dropdown-target="menu"] a {
    color: #60a5fa !important; /* blue-400 */
  }

  /* Ensure hover states are visible */
  .dark [data-dropdown-target="menu"] a:hover,
  .dark [data-dropdown-target="menu"] button:hover {
    background-color: #374151 !important;
    color: #ffffff !important;
  }

  /* Ensure dropdown menus have a shadow */
  [data-dropdown-target="menu"] {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    border-radius: 0.75rem !important;
  }

  /* Fix for dropdown arrow rotation */
  [data-dropdown-target="arrow"][style*="transform: rotate(180deg)"] {
    transform: rotate(180deg) !important;
  }
</style>
