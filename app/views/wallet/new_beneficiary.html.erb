<%# New Beneficiary View - Redesigned %>
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen py-8">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Header - Redesigned with progress indicator -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center">
          <a href="<%= beneficiaries_path %>" class="flex items-center justify-center w-10 h-10 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors mr-3 shadow-sm">
            <%= icon "arrow-left", class: "w-5 h-5" %>
          </a>
          <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Add Beneficiary</h1>
            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">
              Save recipient details for quick transfers
            </p>
          </div>
        </div>
        <div class="hidden sm:block">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300">
            <%= icon "shield-check", class: "w-4 h-4 mr-1" %>
            Secure Form
          </span>
        </div>
      </div>

      <!-- Progress Steps -->
      <div class="relative pt-4">
        <div class="flex mb-2 items-center justify-between">
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 33%"></div>
          </div>
        </div>
        <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 px-1">
          <div class="text-indigo-600 dark:text-indigo-400 font-medium">1. Details</div>
          <div>2. Verify</div>
          <div>3. Confirm</div>
        </div>
      </div>
    </div>

    <!-- Main Content - Redesigned with card style -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-100 dark:border-gray-700">
      <!-- Tabs - Redesigned with icons -->
      <div class="flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750 p-1">
        <button type="button" class="flex-1 py-3 px-4 flex items-center justify-center space-x-2 rounded-lg bg-white dark:bg-gray-800 shadow-sm border-2 border-indigo-500 font-medium text-indigo-600 dark:text-indigo-400" data-tab="bank">
          <%= icon "bank", class: "w-5 h-5" %>
          <span>Bank Transfer</span>
        </button>
        <button type="button" class="flex-1 py-3 px-4 flex items-center justify-center space-x-2 rounded-lg font-medium text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-gray-800 hover:text-gray-700 dark:hover:text-gray-300 transition-all duration-200" data-tab="mobile_money">
          <%= icon "smartphone", class: "w-5 h-5" %>
          <span>Mobile Money</span>
        </button>
        <button type="button" class="flex-1 py-3 px-4 flex items-center justify-center space-x-2 rounded-lg font-medium text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-gray-800 hover:text-gray-700 dark:hover:text-gray-300 transition-all duration-200" data-tab="wallet">
          <%= icon "wallet", class: "w-5 h-5" %>
          <span>Wallet</span>
        </button>
      </div>

      <!-- Form - Redesigned with better styling -->
      <div class="p-6">
        <%= form_with model: @beneficiary, url: beneficiaries_path, method: :post, class: "space-y-6" do |f| %>
          <%= f.hidden_field :transfer_type, value: "bank", id: "transfer_type_field" %>

          <!-- Common Fields - Redesigned with card style -->
          <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
              <%= icon "user", class: "w-5 h-5 mr-2 text-indigo-500" %>
              Beneficiary Information
            </h3>

            <div class="mb-4">
              <label for="beneficiary_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Beneficiary Name</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <%= icon "user", class: "h-5 w-5 text-gray-400" %>
                </div>
                <%= f.text_field :name, id: "beneficiary_name", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500", placeholder: "Enter full name" %>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter the full name as it appears on their account</p>
            </div>
          </div>

          <!-- Bank Transfer Fields - Redesigned -->
          <div id="bank_fields" class="bg-gray-50 dark:bg-gray-750 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
              <%= icon "bank", class: "w-5 h-5 mr-2 text-indigo-500" %>
              Bank Account Details
            </h3>

            <div class="mb-4">
              <label for="beneficiary_bank_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Bank Name</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <%= icon "building", class: "h-5 w-5 text-gray-400" %>
                </div>
                <%= f.select :bank_name,
                  [
                    ["Select Bank", ""],
                    ["Ghana Commercial Bank", "GCB"],
                    ["Ecobank Ghana", "ECO"],
                    ["Fidelity Bank", "FID"],
                    ["Zenith Bank", "ZEN"],
                    ["Standard Chartered", "SCB"]
                  ],
                  { selected: "" },
                  { class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500" }
                %>
              </div>
            </div>

            <div>
              <label for="beneficiary_account_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Account Number</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <%= icon "hash", class: "h-5 w-5 text-gray-400" %>
                </div>
                <%= f.text_field :account_number, id: "beneficiary_account_number", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500", placeholder: "Enter account number" %>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter the bank account number without spaces or special characters</p>
            </div>
          </div>

          <!-- Mobile Money Fields - Redesigned -->
          <div id="mobile_money_fields" class="hidden bg-gray-50 dark:bg-gray-750 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
              <%= icon "smartphone", class: "w-5 h-5 mr-2 text-indigo-500" %>
              Mobile Money Details
            </h3>

            <div class="mb-4">
              <label for="beneficiary_phone_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Phone Number</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <%= icon "phone", class: "h-5 w-5 text-gray-400" %>
                </div>
                <%= f.text_field :phone_number, id: "beneficiary_phone_number", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500", placeholder: "Enter phone number (e.g. 024XXXXXXX)" %>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter the mobile money account phone number</p>
            </div>

            <div class="mb-4">
              <label for="provider_select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Provider</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <%= icon "credit-card", class: "h-5 w-5 text-gray-400" %>
                </div>
                <select id="provider_select" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="">Select Provider</option>
                  <option value="MTN">MTN Mobile Money</option>
                  <option value="VODAFONE">Vodafone Cash</option>
                  <option value="AIRTELTIGO">AirtelTigo Money</option>
                </select>
                <!-- Store the provider in the bank_name field when using mobile_money transfer type -->
                <!-- This is a workaround since we don't have a mobile_provider column -->
                <%= f.hidden_field :bank_name, id: "mobile_provider_hidden" %>
              </div>
            </div>

            <div>
              <label for="beneficiary_account_number_mobile" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Account Number</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <%= icon "hash", class: "h-5 w-5 text-gray-400" %>
                </div>
                <%= f.text_field :account_number, id: "beneficiary_account_number_mobile", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500", placeholder: "Same as phone number", readonly: true %>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">This is automatically filled with the phone number</p>
            </div>
          </div>

          <!-- Wallet Transfer Fields - Redesigned -->
          <div id="wallet_fields" class="hidden bg-gray-50 dark:bg-gray-750 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
              <%= icon "wallet", class: "w-5 h-5 mr-2 text-indigo-500" %>
              Wallet Details
            </h3>

            <div>
              <label for="beneficiary_account_number_wallet" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Wallet ID</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <%= icon "hash", class: "h-5 w-5 text-gray-400" %>
                </div>
                <%= f.text_field :account_number, id: "beneficiary_account_number_wallet", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500", placeholder: "Enter wallet ID (e.g. W12345ABCDEF)" %>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter the 12-character wallet ID starting with 'W'</p>
            </div>
          </div>

          <!-- Avatar Upload - Redesigned -->
          <div class="bg-gray-50 dark:bg-gray-750 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
              <%= icon "image", class: "w-5 h-5 mr-2 text-indigo-500" %>
              Profile Picture
              <span class="ml-2 text-xs font-normal text-gray-500 dark:text-gray-400">(Optional)</span>
            </h3>

            <div class="flex items-center">
              <div class="w-16 h-16 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center mr-4 border-2 border-white dark:border-gray-600 shadow-md overflow-hidden">
                <%= icon "user", class: "w-8 h-8 text-gray-400 dark:text-gray-500", id: "avatar_preview_icon" %>
                <img id="avatar_preview" class="w-full h-full object-cover hidden" src="#" alt="Avatar preview">
              </div>
              <div class="flex-1">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Add a profile picture to easily identify this beneficiary</p>
                <%= f.file_field :avatar, class: "hidden", accept: "image/*", id: "avatar_upload" %>
                <button type="button" class="inline-flex items-center px-4 py-2 border border-indigo-300 dark:border-indigo-700 shadow-sm text-sm font-medium rounded-lg text-indigo-700 dark:text-indigo-300 bg-white dark:bg-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800" onclick="document.getElementById('avatar_upload').click()">
                  <%= icon "upload", class: "w-4 h-4 mr-2" %>
                  Upload Photo
                </button>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">JPG, PNG or GIF up to 5MB</p>
              </div>
            </div>
          </div>

          <!-- Submit Button - Redesigned -->
          <div class="pt-4">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                <%= icon "shield-check", class: "w-4 h-4 mr-1 text-green-500" %>
                Your data is secure and encrypted
              </div>
              <a href="<%= beneficiaries_path %>" class="text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300">Cancel</a>
            </div>

            <%= f.submit "Save Beneficiary", class: "w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500 focus:ring-offset-indigo-200 text-white transition ease-in duration-200 text-center text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-lg" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% content_for :page_helpers do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Tab switching with enhanced styling
      document.querySelectorAll('[data-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab styling
          document.querySelectorAll('[data-tab]').forEach(t => {
            t.classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm', 'border-2', 'border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
            t.classList.add('text-gray-500', 'dark:text-gray-400');
          });
          this.classList.remove('text-gray-500', 'dark:text-gray-400');
          this.classList.add('bg-white', 'dark:bg-gray-800', 'shadow-sm', 'border-2', 'border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');

          // Show/hide appropriate fields with smooth transition
          const tabType = this.getAttribute('data-tab');
          document.getElementById('transfer_type_field').value = tabType;

          // Hide all fields
          ['bank_fields', 'mobile_money_fields', 'wallet_fields'].forEach(id => {
            const element = document.getElementById(id);
            element.classList.add('hidden');
          });

          // Show selected fields
          document.getElementById(`${tabType}_fields`).classList.remove('hidden');

          // Sync account numbers between tabs and handle provider
          if (tabType === 'mobile_money') {
            document.getElementById('beneficiary_account_number_mobile').value = document.getElementById('beneficiary_phone_number').value;

            // When switching to mobile money, we'll use bank_name field to store the provider
            // This is a workaround since we don't have a mobile_provider column
            const providerSelect = document.getElementById('provider_select');
            const mobileProviderHidden = document.getElementById('mobile_provider_hidden');

            // Copy the current provider value to bank_name field
            mobileProviderHidden.value = providerSelect.value;

            // Set up event listener to update bank_name when provider changes
            if (!providerSelect.hasAttribute('data-listener-added')) {
              providerSelect.addEventListener('change', function() {
                mobileProviderHidden.value = this.value;
              });
              providerSelect.setAttribute('data-listener-added', 'true');
            }
          }
        });
      });

      // Form validation
      const form = document.querySelector('form');
      form.addEventListener('submit', function(event) {
        let isValid = true;
        const transferType = document.getElementById('transfer_type_field').value;
        const name = document.getElementById('beneficiary_name').value.trim();

        // Validate name
        if (!name) {
          isValid = false;
          showError('beneficiary_name', 'Beneficiary name is required');
        } else {
          hideError('beneficiary_name');
        }

        // Validate based on transfer type
        if (transferType === 'bank') {
          const bankName = document.querySelector('[name="beneficiary[bank_name]"]').value;
          const accountNumber = document.getElementById('beneficiary_account_number').value.trim();

          if (!bankName) {
            isValid = false;
            showError('beneficiary_bank_name', 'Please select a bank');
          }

          if (!accountNumber) {
            isValid = false;
            showError('beneficiary_account_number', 'Account number is required');
          } else if (!/^\d+$/.test(accountNumber)) {
            isValid = false;
            showError('beneficiary_account_number', 'Account number should contain only digits');
          }
        } else if (transferType === 'mobile_money') {
          const phoneNumber = document.getElementById('beneficiary_phone_number').value.trim();
          const provider = document.getElementById('provider_select').value;

          if (!phoneNumber) {
            isValid = false;
            showError('beneficiary_phone_number', 'Phone number is required');
          } else if (!/^0\d{9}$/.test(phoneNumber)) {
            isValid = false;
            showError('beneficiary_phone_number', 'Please enter a valid 10-digit phone number starting with 0');
          }

          if (!provider) {
            isValid = false;
            showError('provider_select', 'Please select a provider');
          }
        } else if (transferType === 'wallet') {
          const walletId = document.getElementById('beneficiary_account_number_wallet').value.trim();

          if (!walletId) {
            isValid = false;
            showError('beneficiary_account_number_wallet', 'Wallet ID is required');
          } else if (!/^W[A-Z0-9]{11}$/.test(walletId.toUpperCase())) {
            isValid = false;
            showError('beneficiary_account_number_wallet', 'Please enter a valid wallet ID (e.g. W12345ABCDEF)');
          }
        }

        if (!isValid) {
          event.preventDefault();
        }
      });

      // Helper functions for validation
      function showError(fieldId, message) {
        const field = document.getElementById(fieldId);
        field.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');

        // Check if error message already exists
        let errorElement = field.parentNode.querySelector('.error-message');
        if (!errorElement) {
          errorElement = document.createElement('p');
          errorElement.className = 'mt-1 text-xs text-red-500 error-message';
          field.parentNode.appendChild(errorElement);
        }
        errorElement.textContent = message;
      }

      function hideError(fieldId) {
        const field = document.getElementById(fieldId);
        field.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');

        const errorElement = field.parentNode.querySelector('.error-message');
        if (errorElement) {
          errorElement.remove();
        }
      }

      // Sync mobile money account number with phone number
      document.getElementById('beneficiary_phone_number').addEventListener('input', function() {
        document.getElementById('beneficiary_account_number_mobile').value = this.value;
      });

      // Enhanced avatar preview with file size validation
      document.getElementById('avatar_upload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          // Check file size (5MB max)
          const maxSize = 5 * 1024 * 1024; // 5MB in bytes
          if (file.size > maxSize) {
            alert('File is too large. Maximum size is 5MB.');
            this.value = ''; // Clear the file input
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('avatar_preview');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            document.getElementById('avatar_preview_icon').classList.add('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
    });
  </script>
<% end %>
