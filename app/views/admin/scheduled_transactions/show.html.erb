<% content_for :title, "Scheduled Transaction Details" %>

<div class="space-y-6">
  <!-- Header with Actions -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between">
    <div class="flex items-center">
      <%= link_to admin_scheduled_transactions_path, class: "mr-4 text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300" do %>
        <%= icon "arrow-left", class: "w-5 h-5 mr-1" %> Back to Scheduled Transactions
      <% end %>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
        <%= @scheduled_transaction.description || "Scheduled #{@scheduled_transaction.transaction_type.capitalize}" %>
      </h2>
    </div>

    <div class="mt-4 md:mt-0 flex flex-wrap gap-2">
      <%= link_to edit_admin_scheduled_transaction_path(@scheduled_transaction), class: "btn btn-outline" do %>
        <%= icon "pencil", class: "w-5 h-5 mr-2" %>
        Edit
      <% end %>

      <% if @scheduled_transaction.status == 'active' %>
        <%= button_to execute_admin_scheduled_transaction_path(@scheduled_transaction), method: :post, class: "btn btn-primary" do %>
          <%= icon "play", class: "w-5 h-5 mr-2" %>
          Execute Now
        <% end %>

        <%= button_to pause_admin_scheduled_transaction_path(@scheduled_transaction), method: :post, class: "btn btn-warning" do %>
          <%= icon "pause", class: "w-5 h-5 mr-2" %>
          Pause
        <% end %>
      <% elsif @scheduled_transaction.status == 'paused' %>
        <%= button_to resume_admin_scheduled_transaction_path(@scheduled_transaction), method: :post, class: "btn btn-success" do %>
          <%= icon "play", class: "w-5 h-5 mr-2" %>
          Resume
        <% end %>
      <% end %>

      <%= button_to admin_scheduled_transaction_path(@scheduled_transaction), method: :delete, form: { data: { turbo_confirm: "Are you sure you want to delete this scheduled transaction?" } }, class: "btn btn-danger" do %>
        <%= icon "trash", class: "w-5 h-5 mr-2" %>
        Delete
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Transaction Details -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">Transaction Details</h3>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Transaction Type</h4>
              <div class="flex items-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                  <%= case @scheduled_transaction.transaction_type
                      when 'deposit'
                        'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
                      when 'withdrawal'
                        'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'
                      when 'transfer'
                        'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'
                      when 'payment'
                        'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300'
                      else
                        'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                      end %>">
                  <%= @scheduled_transaction.transaction_type.to_s.capitalize %>
                </span>
              </div>
            </div>

            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Status</h4>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                <%= case @scheduled_transaction.status
                    when 'active'
                      'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
                    when 'paused'
                      'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'
                    when 'completed'
                      'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'
                    when 'cancelled'
                      'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'
                    when 'failed'
                      'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                    else
                      'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                    end %>">
                <%= @scheduled_transaction.status.to_s.capitalize %>
              </span>
            </div>

            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Amount</h4>
              <p class="text-lg font-semibold text-gray-900 dark:text-white">
                ₵<%= number_with_delimiter((@scheduled_transaction.amount.nil? ? 0.0 : @scheduled_transaction.amount.to_f).round(2)) %>
              </p>
            </div>

            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Frequency</h4>
              <p class="text-gray-900 dark:text-white">
                <%= @scheduled_transaction.frequency.to_s.titleize %>
              </p>
            </div>

            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Next Occurrence</h4>
              <p class="text-gray-900 dark:text-white">
                <% if @scheduled_transaction.next_occurrence %>
                  <%= @scheduled_transaction.next_occurrence.strftime("%B %d, %Y at %I:%M %p") %>
                  <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1">
                    <%= distance_of_time_in_words_to_now(@scheduled_transaction.next_occurrence) %> from now
                  </span>
                <% else %>
                  Not scheduled
                <% end %>
              </p>
            </div>

            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Last Occurrence</h4>
              <p class="text-gray-900 dark:text-white">
                <% if @scheduled_transaction.last_occurrence %>
                  <%= @scheduled_transaction.last_occurrence.strftime("%B %d, %Y at %I:%M %p") %>
                  <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1">
                    <%= time_ago_in_words(@scheduled_transaction.last_occurrence) %> ago
                  </span>
                <% else %>
                  Never executed
                <% end %>
              </p>
            </div>

            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Occurrences</h4>
              <p class="text-gray-900 dark:text-white">
                <%= @scheduled_transaction.occurrences_count %> of <%= @scheduled_transaction.occurrences_limit || '∞' %>
              </p>
            </div>

            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Created</h4>
              <p class="text-gray-900 dark:text-white">
                <%= @scheduled_transaction.created_at.strftime("%B %d, %Y at %I:%M %p") %>
                <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1">
                  <%= time_ago_in_words(@scheduled_transaction.created_at) %> ago
                </span>
              </p>
            </div>

            <% if @scheduled_transaction.description.present? %>
              <div class="col-span-2">
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Description</h4>
                <p class="text-gray-900 dark:text-white">
                  <%= @scheduled_transaction.description %>
                </p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Transaction History -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">Transaction History</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Transaction ID
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Date
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Amount
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Status
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <% if @transaction_history && @transaction_history.any? %>
                <% @transaction_history.each do |transaction| %>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm font-medium text-gray-900 dark:text-white">
                        <%= transaction.transaction_id %>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm text-gray-900 dark:text-white">
                        <%= transaction.created_at.strftime("%b %d, %Y") %>
                      </div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">
                        <%= transaction.created_at.strftime("%I:%M %p") %>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm font-medium text-gray-900 dark:text-white">
                        ₵<%= number_with_delimiter((transaction.amount.nil? ? 0.0 : transaction.amount.to_f).round(2)) %>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        <%= case transaction.status
                            when 'pending'
                              'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'
                            when 'completed'
                              'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
                            when 'failed'
                              'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'
                            when 'reversed'
                              'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300'
                            else
                              'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                            end %>">
                        <%= transaction.status.to_s.capitalize %>
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <%= link_to admin_transaction_path(transaction), class: "text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300" do %>
                        <%= icon "eye", class: "w-5 h-5" %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                    No transaction history available.
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- User Info -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">User Information</h3>
        </div>
        <div class="p-6">
          <% if @scheduled_transaction.user %>
            <div class="flex items-center mb-4">
              <% if @scheduled_transaction.user.respond_to?(:avatar) && @scheduled_transaction.user.avatar.attached? %>
                <%= image_tag @scheduled_transaction.user.avatar.variant(resize_to_fill: [60, 60]), class: "h-12 w-12 rounded-full mr-4 object-cover" %>
              <% else %>
                <div class="h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                  <%= icon "user", class: "h-6 w-6 text-indigo-500" %>
                </div>
              <% end %>
              <div>
                <div class="text-md font-medium text-gray-900 dark:text-white">
                  <%= @scheduled_transaction.user.respond_to?(:display_name) ? @scheduled_transaction.user.display_name : @scheduled_transaction.user.email %>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  <%= @scheduled_transaction.user.email %>
                </div>
              </div>
            </div>
            <%= link_to admin_user_path(@scheduled_transaction.user), class: "btn btn-outline w-full" do %>
              View User Profile
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <div class="h-12 w-12 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center mx-auto mb-3">
                <%= icon "user", class: "h-6 w-6 text-gray-500 dark:text-gray-400" %>
              </div>
              <p class="text-gray-500 dark:text-gray-400">No user information available</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Wallet Info -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">Wallet Information</h3>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <div>
              <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Source Wallet</h4>
              <div class="flex items-center">
                <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                  <%= icon "credit-card", class: "h-4 w-4 text-blue-500" %>
                </div>
                <div>
                  <div class="text-sm font-medium text-gray-900 dark:text-white">
                    <%= @scheduled_transaction.source_wallet.name rescue "Unknown Wallet" %>
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">
                    Balance: ₵<%= number_with_delimiter((@scheduled_transaction.source_wallet.balance.nil? ? 0.0 : @scheduled_transaction.source_wallet.balance.to_f).round(2)) rescue "N/A" %>
                  </div>
                </div>
              </div>
            </div>

            <% if @scheduled_transaction.destination_wallet %>
              <div>
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Destination Wallet</h4>
                <div class="flex items-center">
                  <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                    <%= icon "credit-card", class: "h-4 w-4 text-green-500" %>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                      <%= @scheduled_transaction.destination_wallet.name rescue "Unknown Wallet" %>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                      Owner: <%= @scheduled_transaction.destination_wallet.user.respond_to?(:display_name) ? @scheduled_transaction.destination_wallet.user.display_name : @scheduled_transaction.destination_wallet.user.email rescue "Unknown" %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>

            <% if @scheduled_transaction.payment_method.present? %>
              <div>
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Payment Method</h4>
                <div class="flex items-center">
                  <div class="h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                    <%= icon "credit-card", class: "h-4 w-4 text-purple-500" %>
                  </div>
                  <div class="text-sm font-medium text-gray-900 dark:text-white">
                    <%= @scheduled_transaction.payment_method %>
                  </div>
                </div>
              </div>
            <% end %>

            <% if @scheduled_transaction.payment_destination.present? %>
              <div>
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Payment Destination</h4>
                <div class="flex items-center">
                  <div class="h-8 w-8 rounded-full bg-yellow-100 flex items-center justify-center mr-3">
                    <%= icon "location-marker", class: "h-4 w-4 text-yellow-500" %>
                  </div>
                  <div class="text-sm font-medium text-gray-900 dark:text-white">
                    <%= @scheduled_transaction.payment_destination %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Metadata -->
      <% if @scheduled_transaction.metadata.present? && !@scheduled_transaction.metadata.empty? %>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Additional Information</h3>
          </div>
          <div class="p-6">
            <div class="space-y-3">
              <% @scheduled_transaction.metadata.each do |key, value| %>
                <div>
                  <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1"><%= key.to_s.titleize %></h4>
                  <p class="text-sm text-gray-900 dark:text-white">
                    <%= value.is_a?(Hash) || value.is_a?(Array) ? JSON.pretty_generate(value) : value.to_s %>
                  </p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
